name: Docker Build Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
    group: ${{ github.ref }}
    cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: corretto
          cache: maven

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.16.0
          cache: yarn
          cache-dependency-path: web/yarn.lock

      - name: Install Yarn
        if: ${{ env.ACT }}
        run: npm install -g yarn@1.22.4

      - name: Install Maven
        if: ${{ env.ACT }}
        run: |
          set -ex \
          && mkdir -p $MAVEN_HOME \
          && curl --location --silent --output /var/tmp/apache-maven-$MAVEN_VERSION-bin.tar.gz https://archive.apache.org/dist/maven/maven-3//$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz \
          && tar xzf /var/tmp/apache-maven-$MAVEN_VERSION-bin.tar.gz -C $MAVEN_HOME --strip-components=1 \
          && rm /var/tmp/apache-maven-$MAVEN_VERSION-bin.tar.gz \
          && update-alternatives --install /usr/bin/mvn mvn /opt/maven/bin/mvn 10000
        env:
          MAVEN_VERSION: 3.8.5
          MAVEN_HOME: /opt/maven

      - name: Run Pipeline Steps
        run: |
          yarn --cwd web --frozen-lockfile
          mvn --batch-mode --threads 2 --define maven.test.skip=true clean package

      - name: Archive Artifact
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v3
        with:
          name: war-file
          path: app/target/*.war
